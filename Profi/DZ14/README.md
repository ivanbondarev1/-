# **IPSec over DmVPN**
## **Топология** 
![](https://github.com/ivanbondarev1/Otus/raw/main/Profi/DZ9/EVE%20_%20Topology%20-%20Google%20Chrome%2021.07.2023%2011_42_48.png?raw=true)



## **Задачи:**
+ ### Настроите GRE поверх IPSec между офисами Москва и С.-Петербург.
+ ### Настроите DMVPN поверх IPSec между Москва и Чокурдах, Лабытнанги.
+ ### Для IPSec использовать CA и сертификаты.





## **Решение**

 

## Настройки:

### **DMVPN:**



### **R14:**
```
crypto pki trustpoint VPN
 enrollment url http://100.22.1.2:80
 ip-address 100.22.1.2
 subject-name CN=R27,OU=VPN,O=Otus,C=RU
 revocation-check none
 rsakeypair VPN
!
!
crypto pki certificate chain VPN
 certificate ca 01
  308201F3 3082015C A0030201 02020101 300D0609 2A864886 F70D0101 04050030
  0D310B30 09060355 04031302 4341301E 170D3233 30393236 30323532 30315A17
  0D323630 39323530 32353230 315A300D 310B3009 06035504 03130243 4130819F
  300D0609 2A864886 F70D0101 01050003 818D0030 81890281 8100AC28 86342E58
  E062F5B9 2B60C151 1B84BD38 A4920822 FFEE7FC0 19FEA6AF 5871D449 0F801ED7
  50D8AE83 04B5966C AF841682 953FE4FA BB7A038B 0FC485FA 0755838E 3C911C34
  EB198E70 A3A722C3 CD8D1C45 4A856116 46854386 6DF81ADA DA331838 7C86C47D
  5DAB7396 68A4E3E7 44B0AFD3 5973B330 0B88056D 7DF77AC1 26C30203 010001A3
  63306130 0F060355 1D130101 FF040530 030101FF 300E0603 551D0F01 01FF0404
  03020186 301F0603 551D2304 18301680 14429E94 8B2DEF15 6D70DAAB 6FCA158B
  273CECDD FD301D06 03551D0E 04160414 429E948B 2DEF156D 70DAAB6F CA158B27
  3CECDDFD 300D0609 2A864886 F70D0101 04050003 81810035 E9205994 EA1B7517
  7934E7EE 8F9C2020 89403BDF CC3293AF E6BA36BE 507922FA 0CEDCB07 F4BEB100
  3CFEC7F2 D16FC0DE D3A88AF7 92F5EF02 FE2CAB96 1349A7FB DC229437 F0725237
  EF1D08EA 4068F5A5 C3EEDA8D 031BA0A3 07425B9F A2298C2B F1F5347F 9BBDBEB2
  875F9CE0 23B800B2 26E0F42D 75E6B03F 5F4D5944 EEDBE1
        quit
!
redundancy
!
!
!
!
!
!
!
crypto isakmp policy 10
 encr aes
 hash md5
 authentication pre-share
 group 5
crypto isakmp key cisco address 0.0.0.0
!
!
crypto ipsec transform-set DMVPV esp-aes esp-sha-hmac
 mode transport
!
crypto ipsec profile DMVPN
 set transform-set DMVPV
!
!
!
!
!
!
!
interface Loopback0
 ip address 14.14.14.14 255.255.255.255
 ip ospf 1 area 0
!
interface Tunnel0
 ip address 99.99.99.14 255.255.255.0
 no ip redirects
 ip nhrp map multicast dynamic
 ip nhrp network-id 99
 ip nhrp registration no-unique
 tunnel source Ethernet0/2
 tunnel mode gre multipoint
 tunnel protection ipsec profile DMVPN
!




```



```
R14#sh crypto isakmp sa
IPv4 Crypto ISAKMP SA
dst             src             state          conn-id status
77.14.2.1       14.25.3.2       QM_IDLE           1001 ACTIVE
77.14.2.1       89.25.1.2       QM_IDLE           1002 ACTIVE

IPv6 Crypto ISAKMP SA

```
```
R14#sh crypto pki certificates
CA Certificate
  Status: Available
  Certificate Serial Number (hex): 01
  Certificate Usage: Signature
  Issuer:
    cn=CA
  Subject:
    cn=CA
  Validity Date:
    start date: 02:52:01 UTC Sep 26 2023
    end   date: 02:52:01 UTC Sep 25 2026
  Associated Trustpoints: VPN
  Storage: nvram:CA#1CA.cer


```



### **R27**:

```
crypto pki trustpoint VPN
 enrollment url http://101.21.2.1:80
 ip-address 101.21.2.1
 subject-name CN=R27,OU=VPN,O=Otus,C=RU
 revocation-check none
 rsakeypair VPN
!
!
crypto pki certificate chain VPN
 certificate 02
  308202BB 30820224 A0030201 02020102 300D0609 2A864886 F70D0101 05050030
  0D310B30 09060355 04031302 4341301E 170D3233 30393237 31303535 33365A17
  0D323430 39323631 30353533 365A3065 310B3009 06035504 06130252 55310D30
  0B060355 040A1304 4F747573 310C300A 06035504 0B130356 504E310C 300A0603
  55040313 03523237 312B3010 06092A86 4886F70D 01090216 03523237 30170609
  2A864886 F70D0109 08130A31 30312E32 312E322E 31308201 22300D06 092A8648
  86F70D01 01010500 0382010F 00308201 0A028201 0100ACC5 3AC24B73 285A4D2A
  C36A9CE8 1C07B561 9F42EB30 F5936D5D 705F2533 B84C2F52 59AD9700 BE0DA850
  AC2AA84A C117D523 98E08E33 97CBCF7D 9668A662 AA3AF944 C83769C3 32D7A7D2
  5CD69EE8 C0182150 0E4496B0 70702C19 56C201D9 77162DA3 E91319C4 9D990417
  F9C095FD F7BE72A5 5A834868 8C6C416F 9AB0F72F 0112FC00 05A6D572 2B4E9651
  514BA857 2705FE65 0EE2F8C6 6C760CAC 98A3915F 32ED638F B8F3A8F8 891D84BE
  41D3852D D4E24010 F675DF6D 87F6FD8B 55B471FD E1DC0F90 12D3E8F5 598FFF3B
  E5958A49 3FE69E2E 9471BCDF 17D29159 5A50DA21 1087709B C8F11855 2DC41100
  CE506986 DEF3C4B8 B4F1BBC8 D7C5D49B 950358B0 004B0203 010001A3 4F304D30
  0B060355 1D0F0404 030205A0 301F0603 551D2304 18301680 14429E94 8B2DEF15
  6D70DAAB 6FCA158B 273CECDD FD301D06 03551D0E 04160414 2990FF1C 823B93E0
  48F91E60 FB88DBED 7A14D69D 300D0609 2A864886 F70D0101 05050003 81810030
  5E3F9E15 C23FF8E4 1ACBE4B9 66F4FC3F BBE78F3B 38DEFBBA A5AB5A22 9AB3B474
  796CE348 8F8C57E2 A605FDF2 B3E77B3A F1593696 E2D6B174 B2B706F1 4EFC72AE
  4892052E F5FDE378 2DAA27B8 CC57820F D403D811 E588A6BC 4CA013B8 2601053F
  FEAB2474 7E1F475A 22FFAB92 33F76BCC 32121D94 6232D393 D9F03AC9 839101
        quit
 certificate ca 01
  308201F3 3082015C A0030201 02020101 300D0609 2A864886 F70D0101 04050030
  0D310B30 09060355 04031302 4341301E 170D3233 30393236 30323532 30315A17
  0D323630 39323530 32353230 315A300D 310B3009 06035504 03130243 4130819F
  300D0609 2A864886 F70D0101 01050003 818D0030 81890281 8100AC28 86342E58
  E062F5B9 2B60C151 1B84BD38 A4920822 FFEE7FC0 19FEA6AF 5871D449 0F801ED7
  50D8AE83 04B5966C AF841682 953FE4FA BB7A038B 0FC485FA 0755838E 3C911C34
  EB198E70 A3A722C3 CD8D1C45 4A856116 46854386 6DF81ADA DA331838 7C86C47D
  5DAB7396 68A4E3E7 44B0AFD3 5973B330 0B88056D 7DF77AC1 26C30203 010001A3
  63306130 0F060355 1D130101 FF040530 030101FF 300E0603 551D0F01 01FF0404
  03020186 301F0603 551D2304 18301680 14429E94 8B2DEF15 6D70DAAB 6FCA158B
  273CECDD FD301D06 03551D0E 04160414 429E948B 2DEF156D 70DAAB6F CA158B27
  3CECDDFD 300D0609 2A864886 F70D0101 04050003 81810035 E9205994 EA1B7517
  7934E7EE 8F9C2020 89403BDF CC3293AF E6BA36BE 507922FA 0CEDCB07 F4BEB100
  3CFEC7F2 D16FC0DE D3A88AF7 92F5EF02 FE2CAB96 1349A7FB DC229437 F0725237
  EF1D08EA 4068F5A5 C3EEDA8D 031BA0A3 07425B9F A2298C2B F1F5347F 9BBDBEB2
  875F9CE0 23B800B2 26E0F42D 75E6B03F 5F4D5944 EEDBE1
        quit
!
redundancy
!
!
!
!
!
!
!
crypto isakmp policy 10
 encr aes
 hash md5
 authentication pre-share
 group 5
crypto isakmp key cisco address 0.0.0.0
!
!
crypto ipsec transform-set DMVPV esp-aes esp-sha-hmac
 mode transport
!
crypto ipsec profile DMVPN
 set transform-set DMVPV
!
!
!
!
!
!
!
interface Tunnel0
 ip address 99.99.99.27 255.255.255.0
 no ip redirects
 ip nhrp map 99.99.99.14 77.14.2.1
 ip nhrp map multicast 77.14.2.1
 ip nhrp network-id 99
 ip nhrp nhs 99.99.99.14
 ip nhrp registration no-unique
 tunnel source Ethernet0/0
 tunnel mode gre multipoint
 tunnel protection ipsec profile DMVPN
!
interface Ethernet0/0
 ip address 89.25.1.2 255.255.255.0

```





### **R28**:

```

crypto pki trustpoint VPN
 enrollment url http://101.21.2.1:80
 ip-address 101.21.2.1
 subject-name CN=R27,OU=VPN,O=Otus,C=RU
 revocation-check none
 rsakeypair VPN
!
!
crypto pki certificate chain VPN
 certificate 03
  308202BB 30820224 A0030201 02020103 300D0609 2A864886 F70D0101 05050030
  0D310B30 09060355 04031302 4341301E 170D3233 30393237 31313132 34385A17
  0D323430 39323631 31313234 385A3065 310B3009 06035504 06130252 55310D30
  0B060355 040A1304 4F747573 310C300A 06035504 0B130356 504E310C 300A0603
  55040313 03523237 312B3010 06092A86 4886F70D 01090216 03523238 30170609
  2A864886 F70D0109 08130A31 30312E32 312E322E 31308201 22300D06 092A8648
  86F70D01 01010500 0382010F 00308201 0A028201 0100B520 2D0CA079 14E03E30
  7D757092 85231A54 EBF65FE4 5498F92F 28775EF6 C4E4F77B DD408323 65E85C48
  6BA9010D 1B48390C EC0E9BA3 28066098 9AAF94F7 CDEE155B 24E9A198 D3EA847D
  D84B06E6 4F6DAE97 F18AE43B C9D52AE4 CDAA9F0B 0C52F3F7 BABDC1BF 2E92FEA3
  BDD249E6 76EA49FE 831C2B5F 00A48BA5 FDE50F85 57C93B91 95643F0D A9EE029F
  32976AB5 9239E9EE EB841264 F96C53E7 1E08FFCF 5A1B5DEE 69C0014C 9DCBA06B
  98D6A679 C1BA4589 F69D15F8 EDD956D1 94C866AC CE2798B5 FD176D90 F884B31C
  592BE9D4 76306DA1 F50B5549 A82F44B6 022D2C49 CA531487 EF760536 3720A898
  4765C28A 2DE9A365 FE6BDEE0 D1ACF2A5 5A327BEA A9E90203 010001A3 4F304D30
  0B060355 1D0F0404 030205A0 301F0603 551D2304 18301680 14429E94 8B2DEF15
  6D70DAAB 6FCA158B 273CECDD FD301D06 03551D0E 04160414 803F65B6 5FA8C867
  07C61100 DE1A57AF CF8EB0D5 300D0609 2A864886 F70D0101 05050003 8181008E
  288FEDE3 54225430 158B4FE7 9C082B0B B4CA7F82 8CAA7AE6 158773E4 86BAE5FD
  159AE749 2C04FA8F 5BEAD767 3200AD7A 1FC0D65E D775A309 0E33D91A 4AC2AAC1
  61DE6EE1 10D64874 DD7BB37E 9BF28F47 45E71389 D3D2627A CE08E153 406E0557
  AC5CA70F AB93449D C8E3AB4B 735A2EFE 45748D47 BD950331 9CCC79E5 EA6B98
        quit
 certificate ca 01
  308201F3 3082015C A0030201 02020101 300D0609 2A864886 F70D0101 04050030
  0D310B30 09060355 04031302 4341301E 170D3233 30393236 30323532 30315A17
  0D323630 39323530 32353230 315A300D 310B3009 06035504 03130243 4130819F
  300D0609 2A864886 F70D0101 01050003 818D0030 81890281 8100AC28 86342E58
  E062F5B9 2B60C151 1B84BD38 A4920822 FFEE7FC0 19FEA6AF 5871D449 0F801ED7
  50D8AE83 04B5966C AF841682 953FE4FA BB7A038B 0FC485FA 0755838E 3C911C34
  EB198E70 A3A722C3 CD8D1C45 4A856116 46854386 6DF81ADA DA331838 7C86C47D
  5DAB7396 68A4E3E7 44B0AFD3 5973B330 0B88056D 7DF77AC1 26C30203 010001A3
  63306130 0F060355 1D130101 FF040530 030101FF 300E0603 551D0F01 01FF0404
  03020186 301F0603 551D2304 18301680 14429E94 8B2DEF15 6D70DAAB 6FCA158B
  273CECDD FD301D06 03551D0E 04160414 429E948B 2DEF156D 70DAAB6F CA158B27
  3CECDDFD 300D0609 2A864886 F70D0101 04050003 81810035 E9205994 EA1B7517
  7934E7EE 8F9C2020 89403BDF CC3293AF E6BA36BE 507922FA 0CEDCB07 F4BEB100
  3CFEC7F2 D16FC0DE D3A88AF7 92F5EF02 FE2CAB96 1349A7FB DC229437 F0725237
  EF1D08EA 4068F5A5 C3EEDA8D 031BA0A3 07425B9F A2298C2B F1F5347F 9BBDBEB2
  875F9CE0 23B800B2 26E0F42D 75E6B03F 5F4D5944 EEDBE1
        quit
!
redundancy
!
!
track 10 ip sla 10 reachability
 delay down 90 up 90
!
track 20 ip sla 20 reachability
 delay down 90 up 90
!
!
!
!
!
!
crypto isakmp policy 10
 encr aes
 hash md5
 authentication pre-share
 group 5
crypto isakmp key cisco address 0.0.0.0
!
!
crypto ipsec transform-set DMVPV esp-aes esp-sha-hmac
 mode transport
!
crypto ipsec profile DMVPN
 set transform-set DMVPV
!
!
!
!
!
!
!
interface Tunnel0
 ip address 99.99.99.28 255.255.255.0
 no ip redirects
 ip nhrp map 99.99.99.14 77.14.2.1
 ip nhrp map multicast 77.14.2.1
 ip nhrp network-id 99
 ip nhrp nhs 99.99.99.14
 ip nhrp registration no-unique
 tunnel source Ethernet0/0
 tunnel mode gre multipoint
 tunnel protection ipsec profile DMVPN
!






```
### **GRE, TLS**:
### **R15**:

```
crypto pki trustpoint VPN
 enrollment url http://77.15.2.2:80
 serial-number
 ip-address 78.15.2.2
 subject-name CN=R27,OU=VPN,O=Otus,C=RU
 revocation-check none
 rsakeypair VPN
!
!
crypto pki certificate chain VPN
 certificate 04
  308202CB 30820234 A0030201 02020104 300D0609 2A864886 F70D0101 05050030
  0D310B30 09060355 04031302 4341301E 170D3233 31303032 30393039 32305A17
  0D323431 30303130 39303932 305A3075 310B3009 06035504 06130252 55310D30
  0B060355 040A1304 4F747573 310C300A 06035504 0B130356 504E310C 300A0603
  55040313 03523237 313B300F 06035504 05130836 37313039 30353630 1006092A
  864886F7 0D010902 16035231 35301606 092A8648 86F70D01 09081309 37382E31
  352E322E 32308201 22300D06 092A8648 86F70D01 01010500 0382010F 00308201
  0A028201 0100BF81 DFD61F3E 0CF5AD9F 1297006B 033CBB3C 69A2AC57 0C83DE8F
  22C08D3D F2C2510E 5AD20FF3 4C67ECB4 1D37A8A9 891949E8 103BFC70 97052DD0
  2AA7862E A11B61AF BA13F5B1 2C996CB9 4B649530 74F07482 54037FDA F84F8A98
  797CC444 28E0275A CF887277 94318838 7463A95A C6C6FC08 05301097 24FB00AB
  B73CCB6B E43EC4E6 DFE1ED28 20C75F60 1D3F0E45 F9A32DD8 D4A6F360 008DA7ED
  A9427B16 58803590 FA8BD963 C4FE1409 9CACD77B 3BE5EE46 3443BA29 6DB77579
  ABFC58BF 67B9BE79 0FA67614 83991FCE 55EE51FF 7E94FF3A 543C64E7 FC6C2A71
  E349551D 67D3F3FF 886186B8 AC8764EA EEA6B651 628999F8 BA53C0F1 410E481F
  70A41FCC 03AB0203 010001A3 4F304D30 0B060355 1D0F0404 030205A0 301F0603
  551D2304 18301680 14429E94 8B2DEF15 6D70DAAB 6FCA158B 273CECDD FD301D06
  03551D0E 04160414 D160555F 83770D2F D13153F7 05B6A631 C99D77B6 300D0609
  2A864886 F70D0101 05050003 81810012 2D69D1C7 5DB3AA6D 7C79F174 89B5C9ED
  56CEE114 F6CBAEF1 36871E71 581AADD6 333559E5 9A859765 15AED682 4E652949
  836BEDEC 528DA185 5F497BBB 02BE9FD6 880B4DCE 1714D289 3DD12357 60006F66
  E29D66EE F2887BC2 3F062100 27BC299A F313C365 F459A10C 1E2FE673 2FAFD94B
  55AF4E62 869AFD84 F11E27A0 88D657
        quit
 certificate ca 01
  308201F3 3082015C A0030201 02020101 300D0609 2A864886 F70D0101 04050030
  0D310B30 09060355 04031302 4341301E 170D3233 30393236 30323532 30315A17
  0D323630 39323530 32353230 315A300D 310B3009 06035504 03130243 4130819F
  300D0609 2A864886 F70D0101 01050003 818D0030 81890281 8100AC28 86342E58
  E062F5B9 2B60C151 1B84BD38 A4920822 FFEE7FC0 19FEA6AF 5871D449 0F801ED7
  50D8AE83 04B5966C AF841682 953FE4FA BB7A038B 0FC485FA 0755838E 3C911C34
  EB198E70 A3A722C3 CD8D1C45 4A856116 46854386 6DF81ADA DA331838 7C86C47D
  5DAB7396 68A4E3E7 44B0AFD3 5973B330 0B88056D 7DF77AC1 26C30203 010001A3
  63306130 0F060355 1D130101 FF040530 030101FF 300E0603 551D0F01 01FF0404
  03020186 301F0603 551D2304 18301680 14429E94 8B2DEF15 6D70DAAB 6FCA158B
  273CECDD FD301D06 03551D0E 04160414 429E948B 2DEF156D 70DAAB6F CA158B27
  3CECDDFD 300D0609 2A864886 F70D0101 04050003 81810035 E9205994 EA1B7517
  7934E7EE 8F9C2020 89403BDF CC3293AF E6BA36BE 507922FA 0CEDCB07 F4BEB100
  3CFEC7F2 D16FC0DE D3A88AF7 92F5EF02 FE2CAB96 1349A7FB DC229437 F0725237
  EF1D08EA 4068F5A5 C3EEDA8D 031BA0A3 07425B9F A2298C2B F1F5347F 9BBDBEB2
  875F9CE0 23B800B2 26E0F42D 75E6B03F 5F4D5944 EEDBE1
        quit
!
redundancy
!
!
!
!
!
!
!
crypto isakmp policy 5
 encr aes
 hash md5
 authentication pre-share
 group 2
crypto isakmp key GRE address 0.0.0.0
!
!
crypto ipsec transform-set IPSEC_TS esp-aes esp-md5-hmac
 mode tunnel
!
crypto ipsec profile GRE
 set transform-set IPSEC_TS
!
!
!
crypto map GRE 1 ipsec-isakmp
 set peer 78.24.3.2
 set transform-set IPSEC_TS
 match address 101
!
!
!
!
!
interface Loopback0
 ip address 15.15.15.15 255.255.255.255
 ip ospf 1 area 0
!
interface Tunnel1
 ip address 88.88.88.15 255.255.255.0
 tunnel source Ethernet0/2
 tunnel destination 78.24.3.2
 tunnel protection ipsec profile GRE
!


```

R15#sh crypto isakmp sa
IPv4 Crypto ISAKMP SA
dst             src             state          conn-id status
77.15.2.1       78.24.3.2       QM_IDLE           1002 ACTIVE
78.24.3.2       77.15.2.1       QM_IDLE           1003 ACTIVE


```

```

### **R18**:

```
crypto pki trustpoint VPN
 enrollment url http://101.21.2.1:80
 serial-number
 subject-name CN=R27,OU=VPN,O=Otus,C=RU
 revocation-check crl
 rsakeypair VPN
!
!
crypto pki certificate chain VPN
 certificate 05
  308202B3 3082021C A0030201 02020105 300D0609 2A864886 F70D0101 05050030
  0D310B30 09060355 04031302 4341301E 170D3233 31303032 30393136 31325A17
  0D323431 30303130 39313631 325A305D 310B3009 06035504 06130252 55310D30
  0B060355 040A1304 4F747573 310C300A 06035504 0B130356 504E310C 300A0603
  55040313 03523237 3123300F 06035504 05130836 37313039 31353230 1006092A
  864886F7 0D010902 16035231 38308201 22300D06 092A8648 86F70D01 01010500
  0382010F 00308201 0A028201 01009AD4 3AA79F90 A959C34F A5EF8F3A 3F9FF731
  24782459 49F8BE77 1ECA5CFA 0945D954 8D475BE2 22545137 765D2FC6 0E3792A9
  2685D0C8 6F95FBD5 27F6A859 D7AC1236 E0BD9F7D FFD727FD AE28FC1F 48DFBF5B
  7455A1A2 5A466D73 503589F8 C9E7098E ED6E8584 78A44CA9 201C89E4 9DC18103
  AFE10EA4 B3F9C5D8 B5573CB7 3040E4A0 6F2A1571 B4D682DD B545F17E E79BBFA1
  64F41083 B1E391F4 514F4C07 B3B70FDF 865415A5 9373C871 6D816096 67ED1C0E
  1A0AE734 2950EB2F E721CBC5 A28AFDE5 4E8DBD32 59848FE6 486BBBD6 C82532D1
  0C520F4B 63F0EA21 8D8F6292 85579493 5D4FCE2B 5DA04355 8D8C5039 F2C67C01
  DF5996F1 53EAA3D3 BE827A3F B3070203 010001A3 4F304D30 0B060355 1D0F0404
  030205A0 301F0603 551D2304 18301680 14429E94 8B2DEF15 6D70DAAB 6FCA158B
  273CECDD FD301D06 03551D0E 04160414 3F254A35 D16BDFCE BAFD5BEB 8DE862F9
  644359FA 300D0609 2A864886 F70D0101 05050003 81810087 5D14144E 9DAAA7CA
  20E055D6 F8882D75 F9AAD87A B3849E2C 6B3B266F 34649741 6F9B8D1B 7654EE2F
  F0C89770 745F1D6F 47B1E710 2987AA4F 9C499E9D 03F06C9B 393B1828 5056B4E2
  FF7F0D66 FE56B206 8EC5AE7F EAB46D7D 9A013EF6 A341BFB6 9133397C D4CD8C94
  68987DA2 4ADA2712 C2071F88 4D50593C 2EE0A26E 594F04
        quit
 certificate ca 01
  308201F3 3082015C A0030201 02020101 300D0609 2A864886 F70D0101 04050030
  0D310B30 09060355 04031302 4341301E 170D3233 30393236 30323532 30315A17
  0D323630 39323530 32353230 315A300D 310B3009 06035504 03130243 4130819F
  300D0609 2A864886 F70D0101 01050003 818D0030 81890281 8100AC28 86342E58
  E062F5B9 2B60C151 1B84BD38 A4920822 FFEE7FC0 19FEA6AF 5871D449 0F801ED7
  50D8AE83 04B5966C AF841682 953FE4FA BB7A038B 0FC485FA 0755838E 3C911C34
  EB198E70 A3A722C3 CD8D1C45 4A856116 46854386 6DF81ADA DA331838 7C86C47D
  5DAB7396 68A4E3E7 44B0AFD3 5973B330 0B88056D 7DF77AC1 26C30203 010001A3
  63306130 0F060355 1D130101 FF040530 030101FF 300E0603 551D0F01 01FF0404
  03020186 301F0603 551D2304 18301680 14429E94 8B2DEF15 6D70DAAB 6FCA158B
  273CECDD FD301D06 03551D0E 04160414 429E948B 2DEF156D 70DAAB6F CA158B27
  3CECDDFD 300D0609 2A864886 F70D0101 04050003 81810035 E9205994 EA1B7517
  7934E7EE 8F9C2020 89403BDF CC3293AF E6BA36BE 507922FA 0CEDCB07 F4BEB100
  3CFEC7F2 D16FC0DE D3A88AF7 92F5EF02 FE2CAB96 1349A7FB DC229437 F0725237
  EF1D08EA 4068F5A5 C3EEDA8D 031BA0A3 07425B9F A2298C2B F1F5347F 9BBDBEB2
  875F9CE0 23B800B2 26E0F42D 75E6B03F 5F4D5944 EEDBE1
        quit
!
redundancy
!
!
!
!
!
!
!
crypto isakmp policy 5
 encr aes
 hash md5
 authentication pre-share
 group 2
crypto isakmp key GRE address 0.0.0.0
!
!
crypto ipsec transform-set IPSEC_TS esp-aes esp-md5-hmac
 mode tunnel
!
crypto ipsec profile GRE
 set transform-set IPSEC_TS
!
!
!
crypto map GRE 1 ipsec-isakmp
 set peer 77.15.2.1
 set transform-set IPSEC_TS
 match address 101
!
!
!
!
!
interface Loopback0
 ip address 180.180.180.180 255.255.255.255
!
interface Loopback1
 no ip address
 ipv6 address 2001::180/128
 ipv6 enable
!
interface Loopback3
 ip address 100.100.100.100 255.255.255.255
!
interface Tunnel0
 ip address 88.88.88.18 255.255.255.0
 tunnel source 78.24.3.2
 tunnel destination 77.15.2.1
 tunnel protection ipsec profile GRE

```



### **R21**:

```
ip domain name R21.ru
ip cef
no ipv6 cef
!
multilink bundle-name authenticated
!
!
!
!
!
!
!
crypto pki server CA
 no database archive
!
crypto pki trustpoint CA
 revocation-check crl
 rsakeypair CA
!
!
crypto pki certificate chain CA
 certificate ca 01
  308201F3 3082015C A0030201 02020101 300D0609 2A864886 F70D0101 04050030
  0D310B30 09060355 04031302 4341301E 170D3233 30393236 30323532 30315A17
  0D323630 39323530 32353230 315A300D 310B3009 06035504 03130243 4130819F
  300D0609 2A864886 F70D0101 01050003 818D0030 81890281 8100AC28 86342E58
  E062F5B9 2B60C151 1B84BD38 A4920822 FFEE7FC0 19FEA6AF 5871D449 0F801ED7
  50D8AE83 04B5966C AF841682 953FE4FA BB7A038B 0FC485FA 0755838E 3C911C34
  EB198E70 A3A722C3 CD8D1C45 4A856116 46854386 6DF81ADA DA331838 7C86C47D
  5DAB7396 68A4E3E7 44B0AFD3 5973B330 0B88056D 7DF77AC1 26C30203 010001A3
  63306130 0F060355 1D130101 FF040530 030101FF 300E0603 551D0F01 01FF0404
  03020186 301F0603 551D2304 18301680 14429E94 8B2DEF15 6D70DAAB 6FCA158B
  273CECDD FD301D06 03551D0E 04160414 429E948B 2DEF156D 70DAAB6F CA158B27
  3CECDDFD 300D0609 2A864886 F70D0101 04050003 81810035 E9205994 EA1B7517
  7934E7EE 8F9C2020 89403BDF CC3293AF E6BA36BE 507922FA 0CEDCB07 F4BEB100
  3CFEC7F2 D16FC0DE D3A88AF7 92F5EF02 FE2CAB96 1349A7FB DC229437 F0725237
  EF1D08EA 4068F5A5 C3EEDA8D 031BA0A3 07425B9F A2298C2B F1F5347F 9BBDBEB2
  875F9CE0 23B800B2 26E0F42D 75E6B03F 5F4D5944 EEDBE1
        quit
!

```


```
R21#sh crypto pki server CA certificates
Serial Issued date              Expire date               Subject Name
1       <cert file not accessible>
2       <cert file not accessible>
3       <cert file not accessible>
4       <cert file not accessible>
5       <cert file not accessible>
6       10:11:32 UTC Oct 2 2023  10:11:32 UTC Oct 1 2024   hostname=R14+ipaddress=100.22.1.2 cn=R27 ou=VPN o=Otus c=RU
7       10:11:32 UTC Oct 2 2023  10:11:32 UTC Oct 1 2024   hostname=R15+ipaddress=78.15.2.2 cn=R27 ou=VPN o=Otus c=RU
8       10:11:32 UTC Oct 2 2023  10:11:32 UTC Oct 1 2024   hostname=R28+ipaddress=101.21.2.1 cn=R27 ou=VPN o=Otus c=RU
9       10:11:33 UTC Oct 2 2023  10:11:33 UTC Oct 1 2024   hostname=R18 cn=R27 ou=VPN o=Otus c=RU
A       10:11:33 UTC Oct 2 2023  10:11:33 UTC Oct 1 2024   hostname=R27+ipaddress=101.21.2.1 cn=R27 ou=VPN o=Otus c=RU


```



